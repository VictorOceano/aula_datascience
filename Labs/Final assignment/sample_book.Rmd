--- 
title: "A Minimal Book Example"
author: "Yihui Xie"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
biblio-style: apalike
link-citations: yes
github-repo: rstudio/bookdown-demo
description: "This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook."
---

# Prerequisites

This is a _sample_ book written in **Markdown**. You can use anything that Pandoc's Markdown supports, e.g., a math equation $a^2 + b^2 = c^2$.

For now, you have to install the development versions of **bookdown** from Github:

```{r eval=FALSE}
#devtools::install_github("rstudio/bookdown")
```

Remember each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading `#`.

To compile this example to PDF, you need to install XeLaTeX.

<!--chapter:end:index.Rmd-->

# Introduction {#intro}

You can label chapter and section titles using `{#label}` after them, e.g., we can reference Chapter \@ref(intro). If you do not manually label them, there will be automatic labels anyway, e.g., Chapter \@ref(methods).

Figures and tables with captions will be placed in `figure` and `table` environments, respectively.

```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center'}
par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

```{r nice-tab, tidy=FALSE}
knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)
```

You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].

<!--chapter:end:01-intro.Rmd-->

# Literature

Here is a review of existing methods.

<!--chapter:end:02-literature.Rmd-->

# Methods

We describe our methods in this chapter.

<!--chapter:end:03-method.Rmd-->

---
title: "Final project"
output:
  github_document: default
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

In this final project, your team will analyze the relationship between three demographic variables and the congressional vote in the 1992 and 2016 elections in one of the four major census regions. Those three variables will be percentage of the population NOT classified as white, non-Hispanic, percentage with a bachelor's degree or higher, and median household income. In each time period, the district value for these variables is the median tract value from the 1990 decennial census and 2011-15 ACS.

Within your group, each person will choose one variable to analyze. You'll look at the statistical and spatial distribution of this variable by state and use regression to analyze the association between it and the House election in each year.

Together, your group will also create a "first difference" model for states in your region, understanding how changes in the district demographics were associated with changes in the states efficiency gap.

The data for this project are all available on a project Github repository: [https://github.com/jshannon75/district_change]. We'll load data directly from there. The final project will also be hosted on this site.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)

proj_region="Midwest Region" #Adjust to fit your group

district_data<-read_csv("https://github.com/jshannon75/district_change/raw/master/districts_data_all.csv") %>%
  mutate(year=as.character(year))
```

This file includes political districts in both 1992 and 2016 (1990 and 2015 in the year field), a variety of demographic variables, and results for the U.S. House elections in both years. There's also some dummy variables for elections that were uncontested (uncon_r and uncon_d), elections with no vote totals (missing), and states with 2 or less districts (dist_omit).

The three demographic variables you're interested in are % not classifed as white, non-hispanic (nonwht_pct), median household income (medhhinc), and % with a BA degree or higher (badeg_pct). 

###Descriptive analysis
First, you should look at the statistical and spatial distribution of your specific variable. As an example, plotting the percent voting for the democratic candidate in the South Region on a ridge plot would look like this. (Note that you'll first need to install the ggridges package. Find more about it (https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html)[in this vignette]). We'll also add a line showing the median value across the region.

Before plotting these data, we will remove all districts with missing data, which have -99 as the vote total. We will also top and bottom code uncontested races, using the figure from Stephanopoulis and McGhee (2015) of 66% of the vote being Democractic in uncontested Democratic races and 36% of the vote being Democratic in uncontested Republican races.

```{r, warning=FALSE, message=FALSE}
library(ggridges)
districts_select<-district_data %>%
  filter(Region==proj_region) %>%
  group_by(year) %>%
  mutate(median_dem=mean(pct_dem),
         pct_dem_adj=ifelse(uncontest_r==1,66,ifelse(uncontest_d==1,36,pct_dem))) %>%
  filter(total_vote!=-99)

ggplot(districts_select,aes(x=pct_dem_adj,y=st_abbr))+
  geom_density_ridges(scale=3)+
  theme_ridges()+
  geom_vline(aes(xintercept = median_dem),col="red")+
  facet_wrap(~year)+
  xlab("Pct. voting Democractic")+
  ylab("")
```

You can also map the data by year using tmap, also filtering out districts with missing data. We will add in state boundaries as well from the shapes statefile, removing the border lines for individual districts.

```{r, warning=FALSE, message=FALSE}
library(tmap)

districts<-st_read("https://github.com/jshannon75/district_change/raw/master/districts_all.geojson",stringsAsFactors=FALSE) 
districts_join<-left_join(districts,districts_select) %>%
  filter(st_abbr!="AK" & st_abbr!="HI")

states<-st_read("https://github.com/jshannon75/district_change/raw/master/USstates_48.geojson") %>% filter(Region==proj_region)

districts_1990<-districts_join %>% filter(year=="1990" & Region==proj_region)
districts_2015<-districts_join %>% filter(year=="2015" & Region==proj_region)

map1<-tm_shape(districts_1990,projection="2163") +
  tm_polygons("pct_dem_adj", breaks=c(0,40,45,50,55,70,100),border.alpha=0)+
  tm_shape(states) + tm_borders()

map2<-tm_shape(districts_2015,projection="2163") +
  tm_polygons("pct_dem_adj", breaks=c(0,40,45,50,55,70,100),border.alpha=0)+
  tm_shape(states) + tm_borders()

tmap_arrange(map1,map2)
```

###Modeling
Now that we've done some descriptive analysis, let's model the relationship between our variable and the democratic vote, adjusted to account for uncontested races.

```{r, warning=FALSE, message=FALSE}
model1990<-lm(pct_dem_adj~hisp_pct,data=districts_1990)
summary(model1990)

model2015<-lm(pct_dem_adj~hisp_pct,data=districts_2015)
summary(model2015)
```

We can also plot each model with ggplot.

```{r, warning=FALSE, message=FALSE}
ggplot(districts_select,aes(x=pct_dem_adj,y=hisp_pct)) + 
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  facet_wrap(~year)
```

We can map out the location of residuals to better understand the model results. To help interpret the residual values, we will use the scale function to convert them to a z score.

```{r, warning=FALSE, message=FALSE}
districts_1990$residuals<-as.numeric(scale(residuals(model1990)))
districts_2015$residuals<-as.numeric(scale(residuals(model2015)))
districts_combine<-rbind(districts_1990,districts_2015)

ggplot(districts_combine,aes(x=residuals))+
  geom_density(fill="grey")+
  facet_wrap(~year)

map3<-tm_shape(districts_1990,projection="2163") +
  tm_polygons("residuals", breaks=c(-2,-1,-0.5,0.5,1,2),border.alpha=0)+
  tm_shape(states) + tm_borders()

map4<-tm_shape(districts_2015,projection="2163") +
  tm_polygons("residuals", breaks=c(-2,-1,-0.5,0.5,1,2),border.alpha=0)+
  tm_shape(states) + tm_borders()

tmap_arrange(map3,map4)
```

###List of requirements for the individual document (30 points total)

1. **Descriptive analysis:** Ridge plots and maps of your variable, along with your interpretation. You are free to calculate additional analysis (e.g., state median values) as needed. (10 points)
3. **Models:** Linear regression models with a scatterplot and fit line as shown above. Interpret the strength of your models based on the regression output, the scatterplot, and any needed additional information you can get from the data frame itself. Focus on the magnitude, direction, and significance of your model output. (10 points)
4. **Diagnostics:** Density plots and maps of model residuals as shown above, along with your interpretation of the output (10 points).

###Group chapter: combined variables

In addition to your individual chapter, you should also write a final chapter as a group. That chapter should do two things. 

First, you should combine your individuals models and create one final model with all your variables included, also using the stargazer package. Your final table should have eight models--the three indivdual models for each year and an additional model in each year with all three variables. You should interpret the result of each combined model, noting changes in the model coefficients compared to the original model and changes in measures showing overall model strength.

Second, you will create a *first differences model* at the state level with the efficency gap as your dependent variable. To do so, you'll need to calculate the mean values for each variable in each year and then calculate change from each year. Load this file with the state efficiency gaps based on our house data. A negative value shows an efficiency gap in favor of Democrats. A positive value favors Republicans.

```{r}
states_effgap<-st_read("https://github.com/jshannon75/district_change/raw/master/USstates_48_effgap.geojson")
```

Then calculate mean values for your variables in each year at state level. Here's an example with the hisp_pct variable, then join to the states dataset. This creates new variables showing the change between the 1992 and 2016 elections

```{r}
district_data_mean<-district_data %>%
  group_by(year,st_abbr) %>%
  summarise(hisp_mean=mean(hisp_pct))

states_effgap_data<-left_join(states_effgap,district_data_mean) %>%
  select(st_abbr,year,hisp_mean,eff_gap) %>%
  gather(hisp_mean,eff_gap,key="var",value="value") %>%
  spread(year,value) %>%
  mutate(chg=`2015`-`1990`) %>%
  select(-`2015`,-`1990`) %>%
  spread(var,chg)
```

You can then run a model with these variables.

```{r}
fd_model<-lm(eff_gap~hisp_mean,data=states_effgap_data)
summary(fd_model)
```

Create a first difference model with your three variables as independent variables and efficency gap as the dependent variable. Interpret the results.

This final chapter will be graded out of 10 points, and this will be added to each individuals' grade assuming equal participation.

<!--chapter:end:assignment.Rmd-->

---
title: "Test code"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's load our data. We're going to look at three variables:

* Percent non-white
* Median household income
* Percent of households in poverty

```{r load_packages_data, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(knitr)
library(tmap)
library(ggridges)
library(googlesheets)
library(kableExtra)
tracts<-st_read("Tract data/US_tracts_all.shp")
#tracts_2015<-st_read("Tract data/US_tract_2015_data.shp")
tracts_select<-tracts %>%
  filter(STATEFP==13 & whtnh_pct>-1)
tracts_long <- tracts_select %>%
  gather(whtnh_pct:nonwht_pct,key="var",value="value")
districts<-st_read("districts_voting.shp")
districts_select<-districts %>%
  filter(STATEFP==13)
```

We can use the factor command to order the variables for plotting/tables

```{r order_variables, warning=FALSE, message=FALSE}
tracts_long$var<-factor(tracts_long$var,
                             levels=c("whtnh_pct","blknh_pct","hisp_pct","asnnh_pct",
                                      "medhhinc","pov100_pct","nonwht_pct"))

tracts_long$CD<-factor(tracts_long$CD,levels=c("01","02","03","04","05","06","07","08",
                                               "10","09","11","12","13","14"))
```

Let's look at just the districts for the 1992 and 2016 elections:

```{r, warning=FALSE, message=FALSE}
districts1990<-districts_select %>% filter(year=="1990")

districts2015<-districts_select %>% filter(year=="2015")

map1<-tm_shape(districts1990) + 
  tm_polygons(col="white",lwd=1,border.col="grey")+
  tm_text("CD",shadow=TRUE,scale=1,auto.placement=TRUE)

map2<-tm_shape(districts2015) + 
  tm_polygons(col="white",lwd=1,border.col="grey")+
  tm_text("CD",shadow=TRUE,scale=1,auto.placement=TRUE)

tmap_arrange(map1,map2)
```

## Distribution
###Pct. non-white

We can use ridge plots to look at our variables. We start by removing geometry from our data. Then we plot.

```{r, warning=FALSE, message=FALSE}
tracts_long_df<-tracts_long
st_geometry(tracts_long_df)<-NULL

ggplot(tracts_select,aes(x=nonwht_pct,y=CD))+
  geom_density_ridges(scale=3)+
  theme_ridges() +
  facet_grid(.~year)
```

Map the data
```{r, warning=FALSE, message=FALSE}
tracts_select90<-tracts_select %>% filter(year=="1990")

tracts_select15<-tracts_select %>% filter(year=="2015")

map1<-tm_shape(tracts_select90) + 
  tm_polygons("nonwht_pct",border.alpha=0,breaks=c(0,10,20,40,60,100),
              title="% non-White, 1990")+
 tm_shape(districts1990) + 
  tm_borders(lwd=2,col="black") 

map2<-tm_shape(tracts_select15) + 
  tm_polygons("nonwht_pct",border.alpha=0,breaks=c(0,10,20,40,60,100),
              title="% non-White, 2015") +
 tm_shape(districts2015) + 
  tm_borders(lwd=2,col="black") 

tmap_arrange(map1,map2)
```

Create a table

```{r, warning=FALSE, message=FALSE}
tracts_table<-tracts_long_df %>%
  filter(var=="nonwht_pct") %>%
  group_by(year,CD) %>%
  summarise(median=median(value),
            iqr=IQR(value))
kable(tracts_table,"html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),full_width=F)
```

###Median household income

```{r, warning=FALSE, message=FALSE}
ggplot(tracts_select,aes(x=medhhinc,y=CD))+
  geom_density_ridges(scale=3)+
  theme_ridges() +
  facet_grid(.~year)

map3<-tm_shape(tracts_select90) + 
  tm_polygons("medhhinc",border.alpha=0,breaks=c(0,20000,40000,60000,200000),
              title="Median hh income, 1990")+
 tm_shape(districts1990) + 
  tm_borders(lwd=2,col="black") 

map4<-tm_shape(tracts_select15) + 
  tm_polygons("medhhinc",border.alpha=0,breaks=c(0,20000,40000,60000,400000),
              title="Median hh income, 2015") +
 tm_shape(districts2015) + 
  tm_borders(lwd=2,col="black") 

tmap_arrange(map3,map4)
```

###Pct. households in poverty
```{r, warning=FALSE, message=FALSE}
ggplot(tracts_select,aes(x=pov100_pct,y=CD))+
  geom_density_ridges(scale=3)+
  theme_ridges() +
  facet_grid(.~year)

map5<-tm_shape(tracts_select90) + 
  tm_polygons("pov100_pct",border.alpha=0,breaks=c(0,10,20,40,100),
              title="% in poverty, 1990")+
 tm_shape(districts1990) + 
  tm_borders(lwd=2,col="black") 

map6<-tm_shape(tracts_select15) + 
  tm_polygons("pov100_pct",border.alpha=0,breaks=c(0,10,20,40,100),
              title="% in poverty, 2015") +
 tm_shape(districts2015) + 
  tm_borders(lwd=2,col="black") 

tmap_arrange(map5,map6)
```

## Election results

Let's look at the percent voting democratic in both years.

```{r, warning=FALSE, message=FALSE}
map1<-tm_shape(districts1990) + 
  tm_polygons("pct_dem",lwd=1,border.col="grey")

map2<-tm_shape(districts2015) + 
  tm_polygons("pct_dem",lwd=1,border.col="grey")

tmap_arrange(map1,map2)
```

Let's look at the association between each variable and voting result in each year.

```{r, warning=FALSE, message=FALSE}
tracts_table1<-tracts_long_df %>%
  group_by(year,CD,var) %>%
  summarise(median=median(value)) %>%
  left_join(districts_select) %>%
  filter(var=="nonwht_pct"|var=="medhhinc"|var=="pov100_pct")

ggplot(tracts_table1,aes(y=pct_dem,x=median)) +
  geom_point()+
  geom_smooth(se=FALSE)+
  #scale_x_continuous(limits = c(25, 75))+
  facet_grid(year~var,scales="free_x")
```

We can also look at the efficiency gap in both years. 
(Walk through this? Could map number of "wasted votes" and then show the number.)

<!--chapter:end:test_file.Rmd-->

